# Alert Rules for Restaurant Platform
# Defines CRITICAL, WARNING, and INFO level alerts

groups:
  # CRITICAL Alerts (PagerDuty)
  - name: critical_alerts
    interval: 1m
    rules:
      # All Desktop Apps disconnected
      - alert: AllDesktopAppsDisconnected
        expr: sum(desktop_app_connections_total) == 0
        for: 5m
        labels:
          severity: critical
          service: desktop-app
        annotations:
          summary: "All Desktop Apps are disconnected"
          description: "No Desktop App connections detected for over 5 minutes. Print functionality is unavailable."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/desktop-app-disconnected"

      # High error rate
      - alert: HighErrorRate
        expr: (sum(rate(http_request_errors_total[1m])) / sum(rate(http_requests_total[1m]))) * 100 > 10
        for: 1m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "Error rate exceeds 10%"
          description: "HTTP error rate is {{ $value | humanizePercentage }} over the last minute."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/high-error-rate"

      # Print test success rate too low
      - alert: LowPrintTestSuccessRate
        expr: (sum(print_test_requests_total{status="success"}) / sum(print_test_requests_total)) * 100 < 80
        for: 5m
        labels:
          severity: critical
          service: printing
        annotations:
          summary: "Print test success rate below 80%"
          description: "Print test success rate is {{ $value | humanizePercentage }}. Print system may be degraded."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/print-test-failures"

      # High authentication failure rate (potential attack)
      - alert: HighAuthenticationFailureRate
        expr: sum(rate(auth_failures_total[1m])) * 60 > 50
        for: 1m
        labels:
          severity: critical
          service: security
        annotations:
          summary: "High authentication failure rate detected"
          description: "{{ $value }} authentication failures per minute. Potential brute force attack."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/auth-attack"

  # WARNING Alerts (Slack)
  - name: warning_alerts
    interval: 5m
    rules:
      # Connection quality degraded
      - alert: ConnectionQualityDegraded
        expr: (connection_quality_distribution{quality="poor"} / sum(connection_quality_distribution)) * 100 > 30
        for: 30m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "Connection quality degraded"
          description: "{{ $value | humanizePercentage }} of connections are in 'poor' quality state."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/connection-quality"

      # High p95 latency
      - alert: HighP95Latency
        expr: histogram_quantile(0.95, sum(rate(print_test_duration_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
          service: printing
        annotations:
          summary: "High p95 print test latency"
          description: "95th percentile print test latency is {{ $value | humanizeDuration }}."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/high-latency"

      # Rate limiting active
      - alert: RateLimitingActive
        expr: rate_limit_active_clients > 10
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "Multiple clients being rate limited"
          description: "{{ $value }} clients are currently rate limited."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/rate-limiting"

      # WebSocket errors increasing
      - alert: WebSocketErrorsIncreasing
        expr: rate(websocket_errors_total[5m]) > 1
        for: 10m
        labels:
          severity: warning
          service: websocket
        annotations:
          summary: "WebSocket errors increasing"
          description: "WebSocket error rate is {{ $value }} per second."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/websocket-errors"

      # Print job failures
      - alert: PrintJobFailuresIncreasing
        expr: rate(print_jobs_failed_total[5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          service: printing
        annotations:
          summary: "Print job failures increasing"
          description: "Print job failure rate is {{ $value }} per second."
          runbook_url: "https://docs.restaurant-platform.com/runbooks/print-failures"

  # INFO Alerts (Email)
  - name: info_alerts
    interval: 15m
    rules:
      # New Desktop App connected
      - alert: NewDesktopAppConnected
        expr: increase(desktop_app_connections_total[5m]) > 0
        for: 1m
        labels:
          severity: info
          service: desktop-app
        annotations:
          summary: "New Desktop App connected"
          description: "A new Desktop App instance has connected."

      # Low correlation ID cache hit rate
      - alert: LowCorrelationIdCacheHitRate
        expr: (correlation_id_cache_hits_total / (correlation_id_cache_hits_total + correlation_id_cache_misses_total)) * 100 < 50
        for: 15m
        labels:
          severity: info
          service: backend
        annotations:
          summary: "Low correlation ID cache hit rate"
          description: "Correlation ID cache hit rate is {{ $value | humanizePercentage }}. Consider increasing cache size."

      # High memory usage
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes / 1024 / 1024 / 1024) > 2
        for: 30m
        labels:
          severity: info
          service: infrastructure
        annotations:
          summary: "High memory usage detected"
          description: "Backend is using {{ $value | humanize }}GB of memory."

      # Desktop App version mismatch
      - alert: DesktopAppVersionMismatch
        expr: count(count by (version) (desktop_app_connections_total)) > 1
        for: 1h
        labels:
          severity: info
          service: desktop-app
        annotations:
          summary: "Multiple Desktop App versions detected"
          description: "{{ $value }} different Desktop App versions are currently connected."

  # SLA Tracking Alerts
  - name: sla_alerts
    interval: 5m
    rules:
      # Availability SLA breach
      - alert: AvailabilitySLABreach
        expr: (1 - (sum(rate(http_requests_total{status=~"5.."}[1h])) / sum(rate(http_requests_total[1h])))) * 100 < 99.9
        for: 5m
        labels:
          severity: critical
          service: sla
        annotations:
          summary: "Availability SLA breached (< 99.9%)"
          description: "Service availability is {{ $value | humanizePercentage }} over the last hour."

      # Print test SLA breach
      - alert: PrintTestSLABreach
        expr: (sum(print_test_requests_total{status="success"}) / sum(print_test_requests_total)) * 100 < 95
        for: 10m
        labels:
          severity: warning
          service: sla
        annotations:
          summary: "Print test success rate SLA breached (< 95%)"
          description: "Print test success rate is {{ $value | humanizePercentage }}."

      # Latency SLA breach
      - alert: LatencySLABreach
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 10m
        labels:
          severity: warning
          service: sla
        annotations:
          summary: "P95 latency SLA breached (> 500ms)"
          description: "95th percentile latency is {{ $value | humanizeDuration }}."
